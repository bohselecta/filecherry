{"version":3,"sources":["../../src/utils/stripper.ts","../../src/utils/console-write-stream.ts","../../src/utils/fanout-write-stream.ts"],"sourcesContent":["export type StripCommand = string | RegExp;\n\nexport function stripper<T extends ArrayLike<S> | S, S>(\n  strip: StripCommand | StripCommand[],\n  obj: T,\n): T extends ArrayLike<unknown> ? Record<string, unknown>[] : Record<string, unknown> {\n  const strips = Array.isArray(strip) ? strip : [strip];\n  const restrips = strips.map((s) => {\n    if (typeof s === \"string\") {\n      const escaped = s.replace(/[-\\\\[\\]\\\\/\\\\{\\\\}\\\\(\\\\)\\\\*\\\\+\\\\?\\\\.\\\\\\\\^\\\\$\\\\|]/g, \"\\\\$&\");\n      return new RegExp(`^${escaped}$`);\n    }\n    return s;\n  });\n  return localStripper(undefined, restrips, obj) as T extends ArrayLike<unknown>\n    ? Record<string, unknown>[]\n    : Record<string, unknown>;\n}\n\nfunction localStripper<T>(path: string | undefined, restrips: RegExp[], obj: T): unknown {\n  if (typeof obj !== \"object\" || obj === null) {\n    return obj;\n  }\n  if (Array.isArray(obj)) {\n    return obj.map((i) => localStripper(path, restrips, i));\n  }\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const ret = { ...obj } as Record<string, any>;\n  const matcher = (key: string, nextPath: string): boolean => {\n    for (const re of restrips) {\n      if (re.test(key) || re.test(nextPath)) {\n        return true;\n      }\n    }\n    return false;\n  };\n  for (const key in ret) {\n    if (Object.prototype.hasOwnProperty.call(ret, key)) {\n      let nextPath: string;\n      if (path) {\n        nextPath = [path, key].join(\".\");\n      } else {\n        nextPath = key;\n      }\n      if (matcher(key, nextPath)) {\n        // eslint-disable-next-line @typescript-eslint/no-dynamic-delete\n        delete ret[key];\n        continue;\n      }\n      if (typeof ret[key] === \"object\") {\n        if (Array.isArray(ret[key])) {\n          ret[key] = ret[key].reduce((acc: unknown[], v, i) => {\n            const toDelete = matcher(key, `${nextPath}[${i}]`);\n            if (!toDelete) {\n              acc.push(localStripper(`${nextPath}[${i}]`, restrips, v));\n            }\n            return acc;\n          }, []);\n        } else {\n          ret[key] = localStripper(nextPath, restrips, ret[key]);\n        }\n      }\n    }\n  }\n  return ret;\n}\n","export class ConsoleWriterStreamDefaultWriter implements WritableStreamDefaultWriter<Uint8Array> {\n  readonly desiredSize: number | null = null;\n  readonly decoder: TextDecoder = new TextDecoder();\n\n  closed: Promise<undefined>;\n  ready: Promise<undefined>;\n  readonly _stream: ConsoleWriterStream;\n\n  constructor(private stream: ConsoleWriterStream) {\n    this._stream = stream;\n    this.ready = Promise.resolve(undefined);\n    this.closed = Promise.resolve(undefined);\n  }\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars, @typescript-eslint/no-explicit-any\n  abort(reason?: any): Promise<void> {\n    throw new Error(\"Method not implemented.\");\n  }\n  async close(): Promise<void> {\n    // noop\n  }\n  releaseLock(): void {\n    this._stream.locked = false;\n    this.ready = Promise.resolve(undefined);\n    this.closed = Promise.resolve(undefined);\n  }\n  write(chunk?: Uint8Array): Promise<void> {\n    let strObj: string | { level: string } = this.decoder.decode(chunk).trimEnd();\n    let output = \"log\";\n    try {\n      strObj = JSON.parse(strObj) as { level: string };\n      output = strObj.level;\n      // eslint-disable-next-line @typescript-eslint/no-unused-vars\n    } catch (e) {\n      /* noop */\n    }\n    switch (output) {\n      case \"error\":\n        // eslint-disable-next-line no-console\n        console.error(strObj);\n        break;\n      case \"warn\":\n        // eslint-disable-next-line no-console\n        console.warn(strObj);\n        break;\n      default:\n        // eslint-disable-next-line no-console\n        console.log(strObj);\n    }\n    return Promise.resolve();\n  }\n}\n\nexport class ConsoleWriterStream implements WritableStream<Uint8Array> {\n  locked = false;\n  _writer?: WritableStreamDefaultWriter<Uint8Array>;\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any, @typescript-eslint/no-unused-vars\n  abort(reason?: any): Promise<void> {\n    throw new Error(\"Method not implemented.\");\n  }\n  close(): Promise<void> {\n    return Promise.resolve();\n  }\n  getWriter(): WritableStreamDefaultWriter<Uint8Array> {\n    if (this.locked) {\n      throw new Error(\"Stream is locked\");\n    }\n    this.locked = true;\n    if (!this._writer) {\n      this._writer = new ConsoleWriterStreamDefaultWriter(this);\n    }\n    return this._writer;\n  }\n}\n","export class FanoutWriteStream implements WritableStreamDefaultWriter<Uint8Array> {\n  readonly _writers: WritableStreamDefaultWriter<Uint8Array>[];\n  readonly ready: Promise<undefined>;\n  readonly closed: Promise<undefined>;\n  readonly desiredSize: number | null = null;\n  constructor(writers: WritableStreamDefaultWriter<Uint8Array>[]) {\n    this._writers = writers;\n    this.ready = Promise.all(this._writers.map((w) => w.ready)).then(() => undefined);\n    this.closed = Promise.all(this._writers.map((w) => w.closed)).then(() => undefined);\n  }\n\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  abort(reason?: any): Promise<void> {\n    return Promise.all(this._writers.map((w) => w.abort(reason))).then(() => {\n      /* do nothing */\n    });\n  }\n  close(): Promise<void> {\n    return Promise.all(this._writers.map((w) => w.close())).then(() => {\n      /* do nothing */\n    });\n  }\n  releaseLock(): void {\n    this._writers.map((w) => w.releaseLock());\n  }\n\n  write(chunk?: Uint8Array): Promise<void> {\n    return Promise.all(this._writers.map((w) => w.write(chunk))).then(() => {\n      /* do nothing */\n    });\n  }\n}\n"],"mappings":"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","names":[]}